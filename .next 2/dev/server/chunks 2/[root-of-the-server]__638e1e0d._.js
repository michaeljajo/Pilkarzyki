module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[project]/src/lib/supabase.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "supabase",
    ()=>supabase,
    "supabaseAdmin",
    ()=>supabaseAdmin
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/@supabase/supabase-js/dist/index.mjs [app-route] (ecmascript) <locals>");
;
const supabaseUrl = ("TURBOPACK compile-time value", "https://vlazwgdlylqvbsvpmoot.supabase.co");
const supabaseKey = ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsYXp3Z2RseWxxdmJzdnBtb290Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTc4NTksImV4cCI6MjA3MzY3Mzg1OX0.g7xoEXl5Wm7X6zX3JK1AcxrhDs4NbqNZRkFtNu85gLk");
const supabase = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(supabaseUrl, supabaseKey);
const supabaseAdmin = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$supabase$2f$supabase$2d$js$2f$dist$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["createClient"])(supabaseUrl, process.env.SUPABASE_SERVICE_ROLE_KEY, {
    auth: {
        autoRefreshToken: false,
        persistSession: false
    }
});
}),
"[externals]/node:crypto [external] (node:crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:crypto", () => require("node:crypto"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/action-async-storage.external.js [external] (next/dist/server/app-render/action-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/action-async-storage.external.js", () => require("next/dist/server/app-render/action-async-storage.external.js"));

module.exports = mod;
}),
"[project]/src/lib/user-manager.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "getOrCreateUser",
    ()=>getOrCreateUser
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/supabase.ts [app-route] (ecmascript)");
;
async function getOrCreateUser(clerkUserId, options = {}) {
    const { selectFields = '*', context = 'User Manager' } = options;
    try {
        // Try to get existing user
        const { data: existingUser, error: fetchError } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('users').select(selectFields).eq('clerk_id', clerkUserId).single();
        if (existingUser) {
            console.log(`${context} - Found existing user:`, existingUser.id);
            return existingUser;
        }
        // If user doesn't exist (not an error, just not found), create them
        if (fetchError?.code === 'PGRST116') {
            console.log(`${context} - Creating new user for Clerk ID:`, clerkUserId);
            const { data: newUser, error: createError } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('users').insert({
                clerk_id: clerkUserId,
                email: `user-${clerkUserId}@temp.com`,
                first_name: 'User',
                last_name: 'Account'
            }).select(selectFields).single();
            if (createError) {
                console.error(`${context} - Error creating user:`, createError);
                throw new Error(`Failed to create user: ${createError.message}`);
            }
            console.log(`${context} - Created new user:`, newUser.id);
            return newUser;
        }
        // If it's a different error, throw it
        if (fetchError) {
            console.error(`${context} - Error fetching user:`, fetchError);
            throw new Error(`Failed to fetch user: ${fetchError.message}`);
        }
        throw new Error('Unexpected error in getOrCreateUser');
    } catch (error) {
        console.error(`${context} - Unexpected error:`, error);
        throw error;
    }
}
}),
"[project]/src/app/api/manager/leagues/[id]/squad/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/supabase.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$clerk$2f$nextjs$2f$dist$2f$esm$2f$app$2d$router$2f$server$2f$auth$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@clerk/nextjs/dist/esm/app-router/server/auth.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$user$2d$manager$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/user-manager.ts [app-route] (ecmascript)");
;
;
;
;
async function GET(request, { params }) {
    try {
        const { userId } = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$clerk$2f$nextjs$2f$dist$2f$esm$2f$app$2d$router$2f$server$2f$auth$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["auth"])();
        if (!userId) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const resolvedParams = await params;
        const leagueId = resolvedParams.id;
        // Check if managerId is provided (admin use case)
        const { searchParams } = new URL(request.url);
        const managerId = searchParams.get('managerId');
        // If managerId is provided, use that for fetching squad
        // Otherwise, use current user's ID
        let targetUserId = null;
        if (managerId) {
            // Admin is requesting another manager's squad
            targetUserId = managerId;
        } else {
            // Get current user record, create if doesn't exist
            const userRecord = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$user$2d$manager$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getOrCreateUser"])(userId, {
                selectFields: 'id, email',
                context: 'Manager Squad API'
            });
            targetUserId = userRecord.id;
        }
        // Get league details
        const { data: league } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('leagues').select('*').eq('id', leagueId).single();
        if (!league) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'League not found'
            }, {
                status: 404
            });
        }
        // Get manager's assigned players for this league
        console.log('Squad API - Looking for players with manager_id:', targetUserId);
        // CRITICAL: Filter by league to prevent cross-league player confusion
        const { data: initialPlayers, error } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('players').select('*').eq('manager_id', targetUserId).eq('league', league.name).order('position').order('name');
        let players = initialPlayers;
        console.log('Squad API - Found players:', players?.length || 0);
        if (error) {
            console.error('Error fetching squad:', error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: error.message
            }, {
                status: 500
            });
        }
        // If no players found and NOT admin request, try to find and fix orphaned players
        if (!players || players.length === 0) {
            if (managerId) {
                // For admin requests, just return empty array if no players found
                console.log('Squad API - No players found for manager:', managerId);
            } else {
                console.log('Squad API - No players found, checking for orphaned players...');
                // Get current user email for matching
                const currentUserEmail = (await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('users').select('email').eq('id', targetUserId).single()).data?.email || '';
                console.log('Squad API - Current user email:', currentUserEmail);
                // Look for duplicate users with the same email but different IDs
                const { data: duplicateUsers } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('users').select('id, email, clerk_id, created_at').eq('email', currentUserEmail).neq('id', targetUserId);
                console.log('Squad API - Found duplicate users:', duplicateUsers);
                // Also check for players assigned to ANY user with this email (including current user)
                const { data: allUsersWithEmail } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('users').select('id, email, clerk_id, created_at').eq('email', currentUserEmail);
                console.log('Squad API - All users with this email:', allUsersWithEmail);
                if (allUsersWithEmail && allUsersWithEmail.length > 0) {
                    const allUserIds = allUsersWithEmail.map((u)=>u.id);
                    // CRITICAL: Filter by league to prevent cross-league player confusion
                    const { data: playersForAllUsers } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('players').select('id, name, position, manager_id').in('manager_id', allUserIds).eq('league', league.name);
                    console.log('Squad API - Players assigned to users with this email:', playersForAllUsers);
                }
                // Look for players assigned to any of these duplicate user IDs
                let orphanedPlayers = [];
                if (duplicateUsers && duplicateUsers.length > 0) {
                    const duplicateIds = duplicateUsers.map((u)=>u.id);
                    // CRITICAL: Filter by league to prevent cross-league player confusion
                    const { data: foundPlayers } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('players').select('*').in('manager_id', duplicateIds).eq('league', league.name);
                    if (foundPlayers && foundPlayers.length > 0) {
                        orphanedPlayers = foundPlayers;
                        console.log('Squad API - Found orphaned players to reassign:', foundPlayers.length);
                        // Reassign all orphaned players to current user
                        const { error: updateError } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('players').update({
                            manager_id: targetUserId
                        }).in('manager_id', duplicateIds);
                        if (updateError) {
                            console.error('Squad API - Error reassigning players:', updateError);
                        } else {
                            console.log('Squad API - Successfully reassigned players to current user');
                            // Fetch the updated players
                            // CRITICAL: Filter by league to prevent cross-league player confusion
                            const { data: updatedPlayers } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('players').select('*').eq('manager_id', targetUserId).eq('league', league.name).order('position').order('name');
                            players = updatedPlayers;
                            console.log('Squad API - Updated player count:', players?.length || 0);
                        }
                    }
                }
            }
        }
        // Get the next incomplete gameweek for the league (sorted by week)
        const { data: currentGameweek } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('gameweeks').select('*').eq('league_id', leagueId).eq('is_completed', false).order('week', {
            ascending: true
        }).limit(1).single();
        // Get existing lineup if any
        let currentLineup = null;
        if (currentGameweek && targetUserId) {
            const { data: lineup } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('lineups').select('*').eq('manager_id', targetUserId).eq('gameweek_id', currentGameweek.id).single();
            currentLineup = lineup;
        }
        // Get default lineup for this league
        let defaultLineup = null;
        if (targetUserId) {
            const { data: defLineup } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('default_lineups').select('*').eq('manager_id', targetUserId).eq('league_id', leagueId).single();
            defaultLineup = defLineup;
        }
        // Check if there's a cup gameweek for this league gameweek
        let currentCupGameweek = null;
        let currentCupLineup = null;
        let cup = null;
        if (currentGameweek) {
            // Check if league has a cup
            const { data: cupData } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('cups').select('*').eq('league_id', leagueId).eq('is_active', true).single();
            if (cupData) {
                cup = cupData;
                // Check if current league gameweek has a cup gameweek mapped to it
                const { data: cupGameweek } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('cup_gameweeks').select('*').eq('cup_id', cupData.id).eq('league_gameweek_id', currentGameweek.id).single();
                if (cupGameweek) {
                    currentCupGameweek = cupGameweek;
                    // Get existing cup lineup if any
                    if (targetUserId) {
                        const { data: cupLineup } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('cup_lineups').select('*').eq('manager_id', targetUserId).eq('cup_gameweek_id', cupGameweek.id).single();
                        currentCupLineup = cupLineup;
                    }
                }
            }
        }
        // Get default cup lineup if cup exists
        let defaultCupLineup = null;
        if (cup && targetUserId) {
            const { data: defCupLineup } = await __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$supabase$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["supabaseAdmin"].from('default_cup_lineups').select('*').eq('manager_id', targetUserId).eq('cup_id', cup.id).single();
            defaultCupLineup = defCupLineup;
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            league,
            players: players || [],
            currentGameweek,
            currentLineup,
            defaultLineup,
            cup,
            currentCupGameweek,
            currentCupLineup,
            defaultCupLineup,
            isDualGameweek: !!(currentGameweek && currentCupGameweek)
        });
    } catch (error) {
        console.error('Error in squad API:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Internal server error'
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__638e1e0d._.js.map